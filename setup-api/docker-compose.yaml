services:
  api:
    # Construire l'image localement depuis le Dockerfile
    build:
      context: ../
      dockerfile: setup-api/Dockerfile
    image: ${PROJECT_NAME:-project-name}-api:latest
    container_name: ${PROJECT_NAME:-project-name}-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8090}:8090"

    # Charger toutes les variables du .env
    env_file:
      - .env

    # Variables d'environnement
    environment:
      # Spring
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILE:-prod}

      # URLs
      APP_BASE_URL: ${APP_BASE_URL}
      APP_FRONTEND_URL: ${APP_FRONTEND_URL}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}

      # MongoDB
      SPRING_DATA_MONGODB_URI: ${SPRING_DATA_MONGODB_URI}
      MONGO_AUTO_INDEX: ${MONGO_AUTO_INDEX}

      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION}

      # Admin (legacy - pour compatibilité)
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_FIRSTNAME: ${ADMIN_FIRSTNAME}
      ADMIN_LASTNAME: ${ADMIN_LASTNAME}

      # Platform Admin (Super Admin Multi-Tenant)
      PLATFORM_ADMIN_EMAIL: ${PLATFORM_ADMIN_EMAIL}
      PLATFORM_ADMIN_PASSWORD: ${PLATFORM_ADMIN_PASSWORD}
      PLATFORM_ADMIN_USERNAME: ${PLATFORM_ADMIN_USERNAME}
      PLATFORM_ADMIN_FIRSTNAME: ${PLATFORM_ADMIN_FIRSTNAME}
      PLATFORM_ADMIN_LASTNAME: ${PLATFORM_ADMIN_LASTNAME}

      # Multi-Tenant Configuration
      TENANT_PLATFORM_DOMAIN: ${TENANT_PLATFORM_DOMAIN}
      TENANT_SUBDOMAIN_PREFIX: ${TENANT_SUBDOMAIN_PREFIX}
      TENANT_HEADER_NAME: ${TENANT_HEADER_NAME}
      TENANT_DEFAULT_PLAN: ${TENANT_DEFAULT_PLAN}
      TENANT_TRIAL_DAYS: ${TENANT_TRIAL_DAYS}
      TENANT_MAX_PER_USER: ${TENANT_MAX_PER_USER}
      TENANT_VERIFY_DNS: ${TENANT_VERIFY_DNS}

      # File Storage
      FILE_STORAGE_BASE_PATH: ${FILE_STORAGE_BASE_PATH}
      FILE_STORAGE_MAX_FILE_SIZE: ${FILE_STORAGE_MAX_FILE_SIZE}
      FILE_STORAGE_ALLOWED_TYPES: ${FILE_STORAGE_ALLOWED_TYPES}
      MULTIPART_MAX_FILE_SIZE: ${MULTIPART_MAX_FILE_SIZE}
      MULTIPART_MAX_REQUEST_SIZE: ${MULTIPART_MAX_REQUEST_SIZE}

      # Logging
      LOG_LEVEL_ROOT: ${LOG_LEVEL_ROOT}
      LOG_LEVEL_APP: ${LOG_LEVEL_APP}
      LOG_LEVEL_MONGO: ${LOG_LEVEL_MONGO}

      # DevTools
      DEVTOOLS_ENABLED: ${DEVTOOLS_ENABLED}

      # Java
      JAVA_OPTS: ${JAVA_OPTS}

      # Email / SMTP
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_SMTP_AUTH: ${MAIL_SMTP_AUTH}
      MAIL_SMTP_STARTTLS: ${MAIL_SMTP_STARTTLS}
      MAIL_CONNECTION_TIMEOUT: ${MAIL_CONNECTION_TIMEOUT}
      MAIL_TIMEOUT: ${MAIL_TIMEOUT}
      MAIL_WRITE_TIMEOUT: ${MAIL_WRITE_TIMEOUT}

      # Email Application
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}
      EMAIL_FRONTEND_URL: ${EMAIL_FRONTEND_URL}
      EMAIL_VERIFICATION_CODE_EXPIRATION: ${EMAIL_VERIFICATION_CODE_EXPIRATION}
      EMAIL_PASSWORD_RESET_TOKEN_EXPIRATION: ${EMAIL_PASSWORD_RESET_TOKEN_EXPIRATION}

    volumes:
      - api-uploads:/app/uploads
      - api-logs:/app/logs
      # Cache Gradle pour accélérer les builds
      - gradle-cache:/root/.gradle

    networks:
      - app-network

    # Note: MongoDB doit être démarré avant (via setup-bd)
    # Le réseau ${PROJECT_NAME}-network sera créé automatiquement par Docker Compose

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_PORT:-8090}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

    # ==========================================
    # LABELS TRAEFIK (Production - optionnel)
    # ==========================================
    # Décommenter ces labels si vous utilisez Traefik comme reverse proxy
    # labels:
    #   - "traefik.enable=true"
    #   # Route pour le domaine principal
    #   - "traefik.http.routers.api.rule=Host(`api.${TENANT_PLATFORM_DOMAIN:-kobecorporation.com}`)"
    #   - "traefik.http.routers.api.entrypoints=websecure"
    #   - "traefik.http.routers.api.tls.certresolver=letsencrypt"
    #   - "traefik.http.services.api.loadbalancer.server.port=8090"
    #   # Route wildcard pour les sous-domaines tenants (kb-saas-*.kobecorporation.com)
    #   - "traefik.http.routers.api-tenants.rule=HostRegexp(`kb-saas-{slug:[a-z0-9-]+}.${TENANT_PLATFORM_DOMAIN:-kobecorporation.com}`)"
    #   - "traefik.http.routers.api-tenants.entrypoints=websecure"
    #   - "traefik.http.routers.api-tenants.tls.certresolver=letsencrypt"

volumes:
  api-uploads:
    name: ${PROJECT_NAME:-project-name}-api-uploads
    driver: local
  api-logs:
    name: ${PROJECT_NAME:-project-name}-api-logs
    driver: local
  gradle-cache:
    name: ${PROJECT_NAME:-project-name}-gradle-cache
    driver: local

networks:
  app-network:
    name: ${PROJECT_NAME:-project-name}-network
    driver: bridge
    external: false
    # Le réseau est créé automatiquement par setup-bd ou setup-api